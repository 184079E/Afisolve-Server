create type roles as table
(
    role int
)
go

create table COMPLAINT_STATUS
(
    statusName varchar(10),
    statusID   int not null
        constraint COMPLAINT_STATUS_pk
            primary key nonclustered
)
go

create table OTP
(
    otpID   int not null
        constraint OTP_pk
            primary key nonclustered,
    otpCode int
)
go

create table ROLE
(
    roleID   int not null
        constraint ROLE_pk
            primary key nonclustered,
    roleName varchar(25)
)
go

create unique index ROLE_roleID_uindex
    on ROLE (roleID)
go

create table USERS
(
    userID        int         not null
        constraint USERS_pk
            primary key nonclustered,
    userEmail     varchar(50) not null,
    password      varchar(20),
    firstName     varchar(40),
    lastName      varchar(40),
    contactNumber varchar(20),
    activeStatus  bit,
    lastLogin     datetime,
    createdBy     varchar(50),
    createdAt     datetime,
    modifiedBy    varchar(50),
    modifiedAt    datetime
)
go

create table PRODUCT
(
    productID            int not null
        constraint PRODUCT_pk
            primary key nonclustered,
    productName          varchar(40),
    category             varchar(20),
    customerID           int
        constraint PRODUCT_USERS_userID_fk_2
            references USERS,
    projectManagerID     int
        constraint PRODUCT_USERS_userID_fk_3
            references USERS,
    accountCoordinatorID int
        constraint PRODUCT_USERS_userID_fk
            references USERS,
    createdAt            datetime,
    createdBy            int,
    modifiedAt           datetime,
    modifiedBy           int
)
go

create table ALLOCATION
(
    developerID int not null
        constraint ALLOCATION_USERS_userID_fk
            references USERS,
    productID   int not null
        constraint ALLOCATION_PRODUCT_productID_fk
            references PRODUCT,
    constraint ALLOCATION_pk
        primary key nonclustered (developerID, productID)
)
go

create table COMPLAINT
(
    complaintID       int not null,
    subComplaintID    int not null,
    description       varchar(5000),
    status            int
        constraint COMPLAINT_COMPLAINT_STATUS_statusID_fk
            references COMPLAINT_STATUS,
    submittedDate     datetime,
    lastDateOfPending datetime,
    wipStartDate      datetime,
    finishedDate      datetime,
    productID         int
        constraint COMPLAINT_PRODUCT_productID_fk
            references PRODUCT
            on update cascade,
    constraint COMPLAINT_pk
        primary key nonclustered (complaintID, subComplaintID)
)
go

create table COMMENT
(
    complaintID     int not null,
    commentID       int not null,
    isImage         bit,
    textOrImageName varchar(max),
    senderID        int
        constraint COMMENT_USERS_userID_fk
            references USERS,
    submittedTime   datetime,
    subComplaintID  int not null,
    constraint COMMENT_pk
        primary key nonclustered (complaintID, commentID),
    constraint COMMENT_COMPLAINT_complaintID_subComplaintID_fk
        foreign key (complaintID, subComplaintID) references COMPLAINT
)
go

create table COMPLAINT_ATTACHMENT_DETAILS
(
    complaintID    int not null,
    subComplaintID int not null,
    imageIndex     int not null,
    imageName      varchar(max),
    constraint COMPLAINT_ATTACHMENT_DETAILS_pk
        primary key nonclustered (complaintID, subComplaintID, imageIndex),
    constraint COMPLAINT_ATTACHMENT_DETAILS_COMPLAINT_complaintID_subComplaintID_fk
        foreign key (complaintID, subComplaintID) references COMPLAINT
            on update cascade on delete cascade
)
go

create table FEEDBACK
(
    complaintID    int not null
        constraint FEEDBACK_pk
            primary key nonclustered,
    satisfaction   int,
    description    varchar(1000),
    subComplaintID int not null,
    constraint FEEDBACK_COMPLAINT_complaintID_subComplaintID_fk
        foreign key (complaintID, subComplaintID) references COMPLAINT
            on update cascade
)
go

create table TASK
(
    taskID               varchar(10) not null
        constraint TASK_pk
            primary key nonclustered,
    complaintID          int,
    subComplaintID       int,
    assignDate           datetime,
    deadline             datetime,
    completed            bit,
    accountCoordinatorID int
        constraint TASK_USERS_userID_fk
            references USERS,
    developerID          int
        constraint TASK_USERS_userID_fk_2
            references USERS,
    constraint TASK_COMPLAINT_complainID_subComplaintID_fk
        foreign key (complaintID, subComplaintID) references COMPLAINT
)
go

create unique index USERS_userEmail_uindex
    on USERS (userEmail)
go

create table USER_ROLE
(
    userID    int not null
        constraint USER_ROLE_USERS_userID_fk
            references USERS,
    roleID    int not null
        constraint USER_ROLE_ROLE_roleID_fk
            references ROLE,
    [default] bit not null,
    constraint USER_ROLE_pk
        primary key nonclustered (roleID, userID)
)
go

CREATE function SelectRole(@role_input varchar)
    Returns int
AS
BEGIN

    if (@role_input = 'Admin')
        begin
            return 5
        end
    if (@role_input = 'Customer')
        begin
            return 0
        end
    if (@role_input = 'Account Coordinator')
        begin
            return 1
        end
    if (@role_input = 'Developer')
        begin
            return 2
        end
    if (@role_input = 'Project Manager')
        begin
            return 3
        end
    if (@role_input = 'CEO')
        begin
            return 4
        end
    return -1
END
go

CREATE PROCEDURE createFeedback @_complaintID int,
                                @_feedback varchar(5000),
                                @_ratedValue int
AS
    BEGIN TRANSACTION

INSERT INTO FEEDBACK
VALUES (@_complaintID,
        @_ratedValue,
        @_feedback,
        0)
    IF @@ROWCOUNT = 0 GOTO errorHandler;

UPDATE COMPLAINT
SET status = 3
where complaintID = @_complaintID
    COMMIT TRANSACTION;
    RETURN 0;

    errorHandler:
    ROLLBACK TRANSACTION
    RETURN -1;
go

CREATE procedure deleteSelectedProduct @_productID INT
as
    if exists(select 1
              from PRODUCT
              where productID = @_productID)
        begin
            DELETE FROM PRODUCT WHERE productID = @_productID;
        end
    else
        begin
            return -1;
        end
go

CREATE procedure deleteSelectedUser @_username VARCHAR(50)
as
DECLARE @userID int;
SELECT @userID = userID
FROM USERS
where userEmail = @_username;
    if exists(select 1
              from USERS
              where userEmail = @_username)
        begin

            DECLARE cursor_email CURSOR LOCAL FOR SELECT userID, roleID FROM USER_ROLE WHERE userID = @userID

            declare @userIDTemp int, @roleID int

            OPEN cursor_email
            fetch next from cursor_email into @userIDTemp, @roleID

            while @@fetch_status = 0
                begin
                    delete from USER_ROLE where userID = @userIDTemp AND roleID = @roleID
                    fetch next from cursor_email into @userIDTemp, @roleID
                end

            DELETE FROM USERS WHERE userEmail = @_username;
            CLOSE cursor_email
        end
    else
        begin
            return -1;
        end
go

CREATE procedure getCustomerComplaintsByStatusID @_customerEmail VARCHAR(50),
                                                 @_reqComplaintsStatus int
as
DECLARE @customerID int;
SELECT @customerID = userID
FROM USERS
where userEmail = @_customerEmail;
    if exists(select 1
              from COMPLAINT c)
        begin
            if (@_reqComplaintsStatus = -1)
                BEGIN
                    select *
                    from COMPLAINT C
                             JOIN PRODUCT P ON C.productID = P.productID
                    where C.subComplaintID != 0
                      and P.customerID = @customerID
                    select *
                    from COMPLAINT C
                             JOIN PRODUCT P ON C.productID = P.productID
                    where C.subComplaintID = 0
                      and P.customerID = @customerID
                    RETURN 0;
                END
            else
                if (@_reqComplaintsStatus = 0)
                    BEGIN
                        select *
                        from COMPLAINT C
                                 JOIN PRODUCT P ON C.productID = P.productID
                        where C.subComplaintID != 0
                          and P.customerID = @customerID
                          and C.status = 0
                        select *
                        from COMPLAINT C
                                 JOIN PRODUCT P ON C.productID = P.productID
                        where C.subComplaintID = 0
                          and P.customerID = @customerID
                          and C.status = 0
                        RETURN 0;
                    END
                else
                    if (@_reqComplaintsStatus = 1)
                        BEGIN
                            select *
                            from COMPLAINT C
                                     JOIN PRODUCT P ON C.productID = P.productID
                            where C.subComplaintID != 0
                              and P.customerID = @customerID
                              and C.status = 1
                            select *
                            from COMPLAINT C
                                     JOIN PRODUCT P ON C.productID = P.productID
                            where C.subComplaintID = 0
                              and P.customerID = @customerID
                              and C.status = 1
                            RETURN 0;
                        END
                    else
                        if (@_reqComplaintsStatus = 2)
                            BEGIN
                                select *
                                from COMPLAINT C
                                         JOIN PRODUCT P ON C.productID = P.productID
                                where C.subComplaintID != 0
                                  and P.customerID = @customerID
                                  and C.status = 2
                                select *
                                from COMPLAINT C
                                         JOIN PRODUCT P ON C.productID = P.productID
                                where C.subComplaintID = 0
                                  and P.customerID = @customerID
                                  and C.status = 2
                                RETURN 0;
                            END
                        else
                            if (@_reqComplaintsStatus = 3)
                                BEGIN


                                    select *
                                    from COMPLAINT C
                                             JOIN PRODUCT P ON C.productID = P.productID
                                    where C.subComplaintID != 0
                                      and P.customerID = @customerID
                                      and C.status = 3
                                    select *
                                    from COMPLAINT C
                                             JOIN PRODUCT P ON C.productID = P.productID


                                    where C.subComplaintID = 0
                                      and P.customerID = @customerID
                                      and C.status = 3
                                    RETURN 0;
                                END
        end
    else
        begin
            GOTO errorHandler;
        end
    COMMIT TRANSACTION;
    RETURN 0;

    errorHandler:
    ROLLBACK TRANSACTION
    RETURN -1;
go

CREATE procedure getSelectedComplaintDetails(@_complaintID int,
                                             @_subComplaintID int)
as
    if exists(select 1
              from COMPLAINT
              where complaintID = @_complaintID
                and subComplaintID = @_subComplaintID)
        begin
            select * from COMPLAINT where complaintID = @_complaintID and subComplaintID = @_subComplaintID

            select statusName
            from COMPLAINT_STATUS C_S
                     JOIN COMPLAINT C on C_S.statusID = C.status
            where c.complaintID = @_complaintID
              and c.subComplaintID = @_subComplaintID

            select productName
            from PRODUCT P
                     JOIN COMPLAINT C2 on P.productID = C2.productID
            where C2.complaintID = @_complaintID
              and C2.subComplaintID = @_subComplaintID

            select userEmail, firstName, lastName
            from USERS USR
                     JOIN PRODUCT P2 on USR.userID = P2.projectManagerID
            where P2.productID = (select P.productID
                                  from PRODUCT P
                                           JOIN COMPLAINT C2 on P.productID = C2.productID
                                  where C2.complaintID = @_complaintID
                                    and C2.subComplaintID = @_subComplaintID)

            select userEmail, firstName, lastName
            from USERS USR
                     JOIN PRODUCT P2 on USR.userID = P2.accountCoordinatorID
            where P2.productID = (select P.productID
                                  from PRODUCT P
                                           JOIN COMPLAINT C2 on P.productID = C2.productID
                                  where C2.complaintID = @_complaintID
                                    and C2.subComplaintID = @_subComplaintID)

            select userEmail, firstName, lastName
            from USERS USR
                     JOIN PRODUCT P2 on USR.userID = P2.customerID
            where P2.productID = (select P.productID
                                  from PRODUCT P
                                           JOIN COMPLAINT C2 on P.productID = C2.productID
                                  where C2.complaintID = @_complaintID
                                    and C2.subComplaintID = @_subComplaintID)

            select *
            from COMPLAINT_ATTACHMENT_DETAILS
            where complaintID = @_complaintID and subComplaintID = @_subComplaintID

            return 0;
        end
    else
        begin
            GOTO errorHandler;
        end
    COMMIT TRANSACTION;
    RETURN 0;

    errorHandler:
    ROLLBACK TRANSACTION
    RETURN -1
go

CREATE procedure getSelectedComplaintDetailsCustomer @_customerEmail VARCHAR(50),
                                                     @_complaintID int,
                                                     @_subComplaintID int
as
DECLARE @customerID int;
SELECT @customerID = userID
FROM USERS
where userEmail = @_customerEmail;
    if (@customerID = (select customerID
                       from PRODUCT P
                                join COMPLAINT C3 on P.productID = C3.productID
                       where C3.complaintID = @_complaintID
                         and c3.subComplaintID = @_subComplaintID))
        begin
            select * from COMPLAINT where complaintID = @_complaintID and subComplaintID = @_subComplaintID
            select statusName
            from COMPLAINT_STATUS CS
                     JOIN COMPLAINT C on CS.statusID = C.status
            where C.complaintID = @_complaintID
              and C.subComplaintID = @_subComplaintID
            select productName
            from PRODUCT P
                     join COMPLAINT C2 on P.productID = C2.productID
            where C2.complaintID = @_complaintID
              and C2.subComplaintID = @_subComplaintID
            select userEmail, firstName, lastName
            from USERS U
            where userID = (select projectManagerID
                            from PRODUCT P
                                     join COMPLAINT C2 on P.productID = C2.productID
                            where C2.complaintID = @_complaintID
                              and C2.subComplaintID = @_subComplaintID)
            select userEmail, firstName, lastName
            from USERS U
            where userID = (select accountCoordinatorID
                            from PRODUCT P
                                     join COMPLAINT C2 on P.productID = C2.productID
                            where C2.complaintID = @_complaintID
                              and C2.subComplaintID = @_subComplaintID)
            select *
            from COMPLAINT_ATTACHMENT_DETAILS
            where complaintID = @_complaintID and subComplaintID = @_subComplaintID
            RETURN 0;
        end
    else
        begin
            --             GOTO errorHandler;
            RETURN 1;
        end
    COMMIT TRANSACTION;
    RETURN 0;

    errorHandler:
    ROLLBACK TRANSACTION
    RETURN -1;
go

CREATE procedure getSelectedProductDetails(@_productID int)
as
    if exists(select 1
              from PRODUCT
              where productID = @_productID)
        begin
            select * from PRODUCT where productID = @_productID
            select userEmail customerEmail, firstName, lastName
            from USERS USR
                     JOIN PRODUCT P1 on USR.userID = P1.customerID
            where P1.productID = @_productID
            select userEmail projectManagerEmail, firstName, lastName
            from USERS USR
                     JOIN PRODUCT P2 on USR.userID = P2.projectManagerID
            where P2.productID = @_productID
            select userEmail accountCoordinatorEmail, firstName, lastName
            from USERS USR
                     JOIN PRODUCT P3 on USR.userID = P3.accountCoordinatorID
            where P3.productID = @_productID

            return 0;
        end
    else
        begin
            GOTO errorHandler;
        end
    COMMIT TRANSACTION;
    RETURN 0;

    errorHandler:
    ROLLBACK TRANSACTION
    RETURN -1
go

CREATE procedure getSelectedUserDetails @_username VARCHAR(50)
as
DECLARE @userID int;
SELECT @userID = userID
FROM USERS
where userEmail = @_username;

    if exists(select 1
              from USERS
              where userEmail = @_username) and
       exists(select 1
              from USER_ROLE ur
              where ur.userID = @userID
                and ur.[default] = 'true')
        begin
            select * from USERS where userEmail = @_username
            select ur.roleID from USER_ROLE ur where ur.userID = @userID;
            select ur.roleID from USER_ROLE ur where ur.userID = @userID and ur.[default] = 'true';
            return 0;
        end
    else
        begin
            GOTO errorHandler;
        end
    COMMIT TRANSACTION;
    RETURN 0;

    errorHandler:
    ROLLBACK TRANSACTION
    RETURN -1;
go

CREATE procedure getSubComplaintsOfSelectedComplain @_complainId VARCHAR(10)
as
    if exists(select 1
              from COMPLAINT c
              where c.complaintID = @_complainId
                and c.subComplaintID != 0)
        begin
            select * from COMPLAINT where subComplaintID != 0 and complaintID = @_complainId
            RETURN 0;
        end
    else
        begin
            --             GOTO errorHandler;
            RETURN 1;
        end
    COMMIT TRANSACTION;
    RETURN 0;

    errorHandler:
    ROLLBACK TRANSACTION
    RETURN -1;
go

CREATE PROCEDURE lodgeComplaint @_customerEmail varchar(50),
                                @_productID int,
                                @_description varchar(5000),
                                @_noOfImages int
AS
    BEGIN TRANSACTION

DECLARE @currentMaxComplaintID int;
DECLARE @complaintID int;
    SET @currentMaxComplaintID = (SELECT MAX(complaintID)
                                  from COMPLAINT) ;
    SET @complaintID = iif(@currentMaxComplaintID is null, 1, @currentMaxComplaintID + 1);

INSERT INTO COMPLAINT
VALUES (@complaintID,
        0,
        @_description,
        0,
        GETDATE(),
        (SELECT DATEADD(day, 2, GETDATE()) AS DateAdd),
        null,
        null,
        @_productID)
    IF @@ROWCOUNT = 0 GOTO errorHandler;

DECLARE @i int;
    SET @i = 0;
    WHILE @i < @_noOfImages
        BEGIN
            SET @i = @i + 1
            /* your code*/
            INSERT INTO COMPLAINT_ATTACHMENT_DETAILS
            VALUES (@complaintID, 0, @i, TRIM(STR(@complaintID)) + '-' + '0' + '-' + TRIM(STR(@i)) + '.png')
        END

SELECT *
FROM COMPLAINT_ATTACHMENT_DETAILS
WHERE complaintID = @complaintID
  and subComplaintID = 0;

    COMMIT TRANSACTION;
    RETURN 0;

    errorHandler:
    ROLLBACK TRANSACTION
    RETURN -1;
go

CREATE PROCEDURE lodgeSubComplaint @_complaintID int,
                                   @_subComplaintDesc varchar(5000)
AS
DECLARE
    @subComplaintID int;
    SET @subComplaintID = ((SELECT MAX(@subComplaintID)
                            from COMPLAIN
                            where complaintID = @_complaintID) + 1);
    BEGIN TRANSACTION

INSERT INTO COMPLAINT
VALUES (@_complaintID,
        iif(@subComplaintID is null, 1, @subComplaintID),
        @_subComplaintDesc,
        0,
        GETDATE(),
        (SELECT DATEADD(day, 2, GETDATE()) AS DateAdd),
        null,
        null,
        (SELECT productID from COMPLAINT where complaintID = @_complaintID and subComplaintID = 0))
UPDATE COMPLAINT
SET status = 0
where complaintID = @_complaintID
    IF @@ROWCOUNT = 0 GOTO errorHandler;

    COMMIT TRANSACTION;
    RETURN 0;

    errorHandler:
    ROLLBACK TRANSACTION
    RETURN -1;
go

CREATE procedure login @_email VARCHAR(50),
                       @_password VARCHAR(20)
as
DECLARE @userID int;
SELECT @userID = userID
FROM USERS
where userEmail = @_email;
    if exists(select 1
              from USERS
              where userEmail = @_email
                and password = @_password)
        begin
            select r.roleName
            from ROLE r,
                 USER_ROLE ur
            where ur.userID = @userID
              and r.roleID = ur.roleID
              and ur.[default] = 1;
            select userEmail username, userID, firstName, lastName from USERS where userEmail = @_email;
            return 0;
        end
    else
        begin
            return -1;
        end
go

CREATE PROCEDURE registerProduct @_productName varchar(40),
                                 @_category varchar(20),
                                 @_customerEmail varchar(50),
                                 @_projectManagerEmail varchar(50),
                                 @_accountCoordinatorEmail varchar(50),
                                 @_createdAdmin varchar(50)
AS
DECLARE @customerID int;
SELECT @customerID = userID
FROM USERS
where userEmail = @_customerEmail;

DECLARE @projectManagerID int;
SELECT @projectManagerID = userID
FROM USERS
where userEmail = @_projectManagerEmail;

DECLARE @accountCoordinatorID int;
SELECT @accountCoordinatorID = userID
FROM USERS
where userEmail = @_accountCoordinatorEmail;

DECLARE @createdAdminID int;
SELECT @createdAdminID = userID
FROM USERS
where userEmail = @_createdAdmin;


DECLARE
    @productID int;
    SET @productID = ((SELECT MAX(productID)
                       from PRODUCT) + 1);
    BEGIN TRANSACTION
    if (not exists(select 1
                   from USER_ROLE
                   where userID = @customerID
                     and roleID = 0))
        begin
            ROLLBACK TRANSACTION
            RETURN -2;
        end
    if (not exists(select 1
                   from USER_ROLE
                   where userID = @accountCoordinatorID
                     and roleID = 1))
        begin
            ROLLBACK TRANSACTION
            RETURN -3;
        end
    if (not exists(select 1
                   from USER_ROLE
                   where userID = @projectManagerID
                     and roleID = 3))
        begin
            ROLLBACK TRANSACTION
            RETURN -4;
        end
INSERT INTO PRODUCT
VALUES (iif(@productID is null, 1, @productID),
        @_productName,
        @_category,
        @customerID,
        @projectManagerID,
        @accountCoordinatorID,
        GETDATE(),
        @createdAdminID, null, null)
    IF @@ROWCOUNT = 0 GOTO errorHandler;

    COMMIT TRANSACTION;
    RETURN 0;

    errorHandler:
    ROLLBACK TRANSACTION
    RETURN -1;
go

CREATE PROCEDURE registerUser @_firstname VARCHAR(40),
                              @_lastname VARCHAR(40),
                              @_email VARCHAR(50),
                              @_password VARCHAR(20),
                              @_roles roles READONLY,
                              @_contactNumber VARCHAR(20),
                              @_defaultRole INT,
                              @_createdAdmin VARCHAR(50),
                              @_clientOtp INT,
                              @_generatedOtpID INT
AS
DECLARE @userID int, @role INT, @generatedOTPValue int;

    SET @userID = ((SELECT MAX(userID)
                    from USERS) + 1);
SELECT @generatedOTPValue = otpCode
FROM OTP
where otpID = @_generatedOtpID;
-- delete otp record from the OTP table
Delete
from OTP
where otpID = @_generatedOtpID

    BEGIN TRANSACTION
DECLARE
    role_cursor CURSOR LOCAL FOR SELECT *
                                 FROM @_roles
    if (@_clientOtp != @generatedOTPValue)
        begin
            ROLLBACK TRANSACTION
            return -2;
        end
    else
        if exists(select 1 from USERS where userEmail = @_email)
            begin
                ROLLBACK TRANSACTION
                return -3;
            end
INSERT INTO USERS
VALUES (iif(@userID is null, 1, @userID),
        @_email,
        @_password,
        @_firstname,
        @_lastname,
        @_contactNumber,
        1,
        null,
        @_createdAdmin,
        GETDATE(),
        null,
        null);
    IF @@ROWCOUNT = 0 GOTO errorHandler;

    OPEN role_cursor
    FETCH NEXT FROM role_cursor INTO @role
    WHILE @@FETCH_STATUS = 0
        BEGIN
            IF @role = @_defaultRole
                BEGIN
                    INSERT INTO USER_ROLE VALUES (iif(@userID is null, 1, @userID), @role, 1);
                END
            ELSE
                BEGIN
                    INSERT INTO USER_ROLE VALUES (iif(@userID is null, 1, @userID), @role, 0);
                END

            FETCH NEXT FROM role_cursor INTO @role
        END
    CLOSE role_cursor

    COMMIT TRANSACTION;
    RETURN 0;

    errorHandler:
    ROLLBACK TRANSACTION
    RETURN -1;
go

CREATE procedure roleChange @_username VARCHAR(50),
                            @_requestedRole VARCHAR(25)
as
DECLARE @userID int;
SELECT @userID = userID
FROM USERS
where userEmail = @_username;
    if exists(select 1
              from USER_ROLE ur
                       join ROLE r on r.roleID = ur.roleID
              where ur.userID = @userID
                and r.roleName = @_requestedRole)
        begin
            select r.roleName
            from ROLE r
                     join USER_ROLE ur on r.roleID = ur.roleID
            where ur.userID = @userID
              and r.roleName = @_requestedRole;
            select userEmail username, userID from USERS where userEmail = @_username;
            return 0;
        end
    else
        begin
            return -1;
        end
go

CREATE PROCEDURE saveAndReturnOTP @_generatedOTP int
AS
    BEGIN TRANSACTION
DECLARE
    @maxOtpID int,
    @otpID    int;
    SET @maxOtpID = ((SELECT MAX(otpID)
                      from OTP) + 1);
    SET @otpID = iif(@maxOtpID is null, 1, @maxOtpID)
INSERT INTO OTP
VALUES (@otpID,
        @_generatedOTP)
    IF @@ROWCOUNT = 0 GOTO errorHandler;
SELECT otpID
FROM OTP
where otpID = @otpID
    COMMIT TRANSACTION
    RETURN 0;

    errorHandler:
    ROLLBACK TRANSACTION
    RETURN -1;
go

CREATE PROCEDURE saveComment @_senderEmail varchar(50),
                             @_complaintID int,
                             @_text varchar(MAX),
                             @_noOfImages int
AS
DECLARE @senderID int;
SELECT @senderID = userID
FROM USERS
where userEmail = @_senderEmail;
    BEGIN TRANSACTION


DECLARE @currentMaxCommentID int;
DECLARE @commentID int;
    SET @currentMaxCommentID = (SELECT MAX(commentID)
                                from COMMENT
                                where complaintID = @_complaintID) ;
    SET @commentID = iif(@currentMaxCommentID is null, 1, @currentMaxCommentID + 1);
    IF (@_text != '')
        BEGIN
            INSERT INTO COMMENT
            VALUES (@_complaintID,
                    @commentID,
                    0,
                    @_text,
                    @senderID,
                    GETDATE(),
                    0)
            IF @@ROWCOUNT = 0 GOTO errorHandler;
        end
    SET @currentMaxCommentID = (SELECT MAX(commentID)
                                from COMMENT
                                where complaintID = @_complaintID) ;
    SET @commentID = iif(@currentMaxCommentID is null, 1, @currentMaxCommentID + 1);
DECLARE @i int;
    SET @i = 0;
    WHILE @i < @_noOfImages
        BEGIN
            SET @i = @i + 1
            /* your code*/
            INSERT INTO COMMENT
            VALUES (@_complaintID, @commentID, 1, TRIM(STR(@_complaintID)) + '-' + TRIM(STR(@commentID)) + '.png',
                    @senderID, GETDATE(), 0)
            SELECT * FROM COMMENT where complaintID = @_complaintID and commentID = @commentID
            SET @commentID = @commentID + 1
        END

    COMMIT TRANSACTION;
    RETURN 0;

    errorHandler:
    ROLLBACK TRANSACTION
    RETURN -1;
go

CREATE procedure updateSelectedUserDetails @_oldEmail VARCHAR(50),
                                           @_firstname VARCHAR(40),
                                           @_lastname VARCHAR(40),
                                           @_newEmail VARCHAR(50),
                                           @_password VARCHAR(20),
                                           @_roles roles READONLY,
                                           @_contactNumber VARCHAR(20),
                                           @_defaultRole INT,
                                           @_modifiedAdmin VARCHAR(50),
                                           @_clientOtp INT,
                                           @_generatedOtpID INT
AS
DECLARE @userID int, @userIDTemp int, @roleID int, @role INT, @generatedOTPValue int;

SELECT @userID = userID
FROM USERS
where userEmail = @_oldEmail;
SELECT @generatedOTPValue = otpCode
FROM OTP
where otpID = @_generatedOtpID;
    -- delete otp record from the OTP table
Delete
from OTP
where otpID = @_generatedOtpID

    BEGIN TRANSACTION
DECLARE
    cursor_email CURSOR LOCAL FOR SELECT userID, roleID
                                  FROM USER_ROLE
                                  WHERE userID = @userID
DECLARE
    role_cursor CURSOR LOCAL FOR SELECT *
                                 FROM @_roles
    if (@_oldEmail != @_newEmail and @_clientOtp != @generatedOTPValue)
        begin
            ROLLBACK TRANSACTION
            return -2;
        end
    else
        if (@_oldEmail != @_newEmail and exists(select 1 from USERS where userEmail = @_newEmail))
            begin
                ROLLBACK TRANSACTION
                return -3;
            end

    OPEN cursor_email
    fetch next from cursor_email into @userIDTemp, @roleID
    while @@fetch_status = 0
        begin
            delete from USER_ROLE where userID = @userIDTemp AND roleID = @roleID
            fetch next from cursor_email into @userIDTemp, @roleID
        end
    CLOSE cursor_email
UPDATE USERS
SET userEmail    = @_newEmail,
    firstName    = @_firstname,
    lastName     = @_lastname,
    password     = @_password,
    contactNumber= @_contactNumber,
    modifiedBy   = @_modifiedAdmin,
    modifiedAt   = GETDATE()
WHERE userEmail = @_oldEmail;

    OPEN role_cursor
    FETCH NEXT FROM role_cursor INTO @role
    WHILE @@FETCH_STATUS = 0
        BEGIN
            IF @_defaultRole = null
                BEGIN
                    GOTO errorHandler;
                END
            ELSE
                IF @role = @_defaultRole
                    BEGIN
                        INSERT INTO USER_ROLE VALUES (@userID, @role, 1);
                    END
                ELSE
                    BEGIN
                        INSERT INTO USER_ROLE VALUES (@userID, @role, 0);
                    END

            FETCH NEXT FROM role_cursor INTO @role
        END
    CLOSE role_cursor

SELECT *
from USERS
where userEmail = @_newEmail
    COMMIT TRANSACTION;
    RETURN 0;

    errorHandler:
    ROLLBACK TRANSACTION
    RETURN -1;
go

CREATE procedure userToolbarDetails @_username VARCHAR(50)
as
DECLARE @userID int;
SELECT @userID = userID
FROM USERS
where userEmail = @_username;
    if exists(select 1
              from USERS
              where userEmail = @_username)
        begin
            select firstName from USERS where userEmail = @_username

            select r.roleName
            from ROLE r,
                 USER_ROLE ur
            where ur.userID = @userID
              and r.roleID = ur.roleID;

            select r.roleName defaultRole
            from ROLE r,
                 USER_ROLE ur
            where ur.userID = @userID
              and r.roleID = (
                select roleID from USER_ROLE where USER_ROLE.userID = @userID and [default] = 'true'
            );

            return 0;
        end
    else
        begin
            return -1;
        end
go

